/*
 * led.c
 *
 *  Created on: Jul 24, 2021
 *      Author: george
 */

#include <string.h>

#include <ti/sysbios/knl/Clock.h>
#include <ti/sysbios/knl/Event.h>

#include <badge.h>
#include <badge_drivers/led.h>
#include <badge_drivers/tlc6983.h>
#include <badge_drivers/storage.h>

led_anim_t led_anim_curr;
led_anim_t led_anim_ambient;
led_anim_t led_anim_idle;
led_anim_t led_anim_last_chosen;
uint8_t led_curr_ambient = 0;

uint16_t led_anim_frame = 0;
uint8_t led_anim_direct = 1;
uint16_t led_anim_id = 0;

Clock_Handle led_frame_clock_h;

#include "led_anims.c"

const led_anim_t send_anim = {
                                      "send",
                                      (led_anim_direct_t){
                                          .anim_frames=send_frames,
                                          .anim_len=6,
                                          .anim_frame_delay_ms=150
                                      },
                                      0,
                                      1
};

const led_anim_t recv_anim = {
                                      "recv",
                                      (led_anim_direct_t){
                                          .anim_frames=recv_frames,
                                          .anim_len=6,
                                          .anim_frame_delay_ms=150
                                      },
                                      0,
                                      1
};

const led_anim_direct_t led_startup_anim_direct = {
    (rgbcolor_t (*)[7][15]) &startup_frames,
    24,
    50,
};

const led_anim_t startup_anim = {
                                      "startup",
                                      (led_anim_direct_t){
                                          .anim_frames=startup_frames,
                                          .anim_len=67,
                                          .anim_frame_delay_ms=115
                                      },
                                      0,
                                      1
};

const rgbcolor_t explosion_frames[10][7][15] = {{{{0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 1}, {131, 120, 19}, {222, 220, 86}, {250, 248, 125}, {222, 220, 83}, {130, 119, 20}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, }, {{0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {2, 1, 1}, {23, 22, 6}, {46, 43, 0}, {23, 21, 6}, {2, 1, 1}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, }, {{0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, }, {{0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, }, {{0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, }, {{0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, }, {{0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, }, },
{{{0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {30, 24, 0}, {236, 220, 7}, {255, 245, 0}, {255, 254, 134}, {254, 254, 214}, {255, 254, 129}, {255, 245, 0}, {234, 217, 9}, {28, 23, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, }, {{0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {11, 8, 0}, {203, 173, 1}, {239, 225, 23}, {255, 255, 37}, {255, 255, 19}, {255, 255, 37}, {239, 225, 24}, {202, 172, 1}, {9, 7, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, }, {{0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {20, 13, 0}, {50, 38, 1}, {30, 25, 3}, {144, 121, 10}, {218, 211, 4}, {142, 120, 9}, {30, 25, 4}, {50, 37, 1}, {19, 12, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, }, {{0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {3, 0, 0}, {15, 8, 0}, {2, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, }, {{0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, }, {{0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, }, {{0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, }, },
{{{0, 0, 0}, {12, 8, 0}, {196, 59, 0}, {255, 116, 0}, {255, 253, 53}, {254, 255, 221}, {254, 254, 255}, {254, 254, 253}, {254, 254, 255}, {254, 255, 218}, {255, 251, 50}, {255, 114, 0}, {193, 60, 0}, {10, 7, 0}, {0, 0, 0}, }, {{0, 0, 0}, {0, 0, 0}, {79, 19, 0}, {251, 76, 0}, {255, 118, 0}, {255, 227, 35}, {254, 255, 181}, {254, 255, 225}, {254, 255, 176}, {255, 226, 32}, {255, 117, 0}, {250, 76, 0}, {76, 20, 0}, {0, 0, 0}, {0, 0, 0}, }, {{0, 0, 0}, {0, 0, 0}, {34, 9, 0}, {239, 59, 0}, {255, 111, 0}, {255, 205, 0}, {255, 244, 9}, {255, 255, 32}, {255, 243, 8}, {255, 205, 0}, {255, 111, 0}, {239, 59, 0}, {31, 9, 0}, {0, 0, 0}, {0, 0, 0}, }, {{0, 0, 0}, {0, 0, 0}, {8, 2, 0}, {148, 73, 0}, {255, 168, 0}, {255, 145, 0}, {255, 174, 0}, {255, 184, 0}, {255, 174, 0}, {255, 146, 0}, {255, 167, 0}, {146, 71, 0}, {8, 2, 0}, {0, 0, 0}, {0, 0, 0}, }, {{0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {26, 16, 0}, {80, 53, 0}, {196, 49, 0}, {255, 68, 0}, {255, 65, 0}, {255, 68, 0}, {193, 50, 0}, {80, 53, 0}, {25, 16, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, }, {{0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {39, 4, 0}, {185, 27, 0}, {220, 44, 0}, {184, 26, 0}, {36, 3, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, }, {{0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {1, 1, 0}, {12, 10, 0}, {1, 1, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, }, },
{{{171, 20, 0}, {255, 98, 0}, {255, 204, 0}, {255, 234, 39}, {255, 254, 135}, {255, 255, 0}, {255, 254, 0}, {255, 245, 0}, {255, 254, 0}, {255, 255, 0}, {255, 254, 136}, {255, 235, 35}, {255, 203, 0}, {255, 96, 0}, {168, 19, 0}, }, {{146, 0, 0}, {255, 63, 0}, {255, 166, 0}, {255, 239, 70}, {255, 255, 184}, {255, 255, 82}, {255, 255, 5}, {255, 254, 4}, {255, 255, 7}, {255, 255, 85}, {255, 255, 183}, {255, 239, 66}, {255, 165, 0}, {255, 60, 0}, {142, 0, 0}, }, {{116, 5, 0}, {251, 38, 0}, {255, 124, 0}, {255, 247, 42}, {255, 255, 133}, {255, 255, 206}, {255, 255, 81}, {255, 255, 23}, {255, 255, 85}, {255, 255, 207}, {255, 255, 130}, {255, 246, 40}, {255, 121, 0}, {251, 37, 0}, {112, 5, 0}, }, {{9, 2, 0}, {177, 35, 0}, {255, 115, 0}, {255, 140, 0}, {255, 166, 0}, {255, 230, 60}, {255, 250, 71}, {255, 252, 50}, {255, 250, 73}, {255, 229, 58}, {255, 164, 0}, {255, 140, 0}, {255, 114, 0}, {173, 33, 0}, {8, 2, 0}, }, {{0, 2, 0}, {131, 24, 0}, {253, 72, 0}, {255, 93, 0}, {255, 44, 0}, {255, 90, 0}, {255, 211, 0}, {255, 224, 2}, {255, 209, 0}, {255, 87, 0}, {255, 45, 0}, {255, 92, 0}, {253, 70, 0}, {129, 23, 0}, {0, 2, 0}, }, {{0, 0, 0}, {10, 0, 0}, {220, 28, 0}, {255, 90, 0}, {255, 103, 0}, {255, 110, 0}, {255, 140, 0}, {255, 154, 0}, {255, 140, 0}, {255, 110, 0}, {255, 102, 0}, {255, 89, 0}, {217, 27, 0}, {8, 0, 0}, {0, 0, 0}, }, {{0, 0, 0}, {0, 0, 0}, {76, 2, 0}, {223, 15, 0}, {243, 19, 0}, {251, 43, 0}, {255, 92, 0}, {255, 71, 0}, {255, 93, 0}, {250, 43, 0}, {244, 19, 0}, {222, 15, 0}, {73, 1, 0}, {0, 0, 0}, {0, 0, 0}, }, },
{{{255, 21, 0}, {255, 76, 0}, {255, 158, 0}, {255, 186, 0}, {255, 212, 0}, {255, 148, 0}, {255, 73, 0}, {255, 27, 0}, {255, 74, 0}, {255, 149, 0}, {255, 213, 0}, {255, 186, 0}, {255, 157, 0}, {255, 72, 0}, {255, 22, 0}, }, {{255, 0, 0}, {255, 82, 0}, {255, 236, 0}, {255, 253, 0}, {255, 250, 0}, {255, 193, 0}, {255, 96, 0}, {255, 69, 0}, {255, 97, 0}, {255, 194, 0}, {255, 250, 0}, {255, 253, 0}, {255, 234, 0}, {255, 78, 0}, {255, 0, 0}, }, {{255, 38, 0}, {255, 127, 4}, {255, 255, 10}, {255, 255, 0}, {255, 252, 0}, {255, 226, 0}, {255, 120, 0}, {255, 57, 0}, {255, 123, 0}, {255, 228, 0}, {255, 253, 0}, {255, 255, 0}, {255, 255, 10}, {255, 123, 5}, {255, 35, 0}, }, {{255, 114, 0}, {255, 158, 4}, {255, 250, 39}, {255, 255, 5}, {255, 254, 0}, {255, 251, 0}, {255, 205, 0}, {255, 152, 0}, {255, 206, 0}, {255, 252, 0}, {255, 255, 0}, {255, 255, 5}, {255, 249, 37}, {255, 156, 4}, {255, 112, 0}, }, {{255, 54, 0}, {255, 116, 0}, {255, 140, 23}, {255, 251, 44}, {255, 255, 4}, {255, 255, 0}, {255, 255, 0}, {255, 255, 0}, {255, 255, 0}, {255, 255, 0}, {255, 255, 5}, {255, 250, 44}, {255, 139, 22}, {255, 115, 0}, {255, 51, 0}, }, {{255, 11, 0}, {255, 92, 0}, {255, 115, 0}, {255, 158, 30}, {255, 226, 9}, {255, 255, 1}, {255, 255, 0}, {255, 255, 0}, {255, 255, 0}, {255, 255, 2}, {255, 224, 10}, {255, 157, 29}, {255, 115, 0}, {255, 90, 0}, {255, 12, 0}, }, {{255, 24, 0}, {255, 96, 0}, {255, 146, 0}, {255, 107, 0}, {255, 111, 0}, {255, 194, 3}, {255, 226, 5}, {255, 218, 0}, {255, 227, 5}, {255, 193, 3}, {255, 109, 0}, {255, 108, 0}, {255, 145, 0}, {255, 97, 0}, {255, 25, 0}, }, },
{{{255, 33, 0}, {255, 53, 0}, {255, 64, 0}, {255, 65, 0}, {255, 77, 0}, {255, 28, 0}, {255, 0, 0}, {255, 0, 0}, {255, 0, 0}, {255, 27, 0}, {255, 76, 0}, {255, 64, 0}, {255, 65, 0}, {255, 53, 0}, {255, 33, 0}, }, {{255, 88, 0}, {255, 143, 0}, {255, 166, 0}, {255, 155, 0}, {255, 100, 0}, {255, 18, 0}, {255, 0, 0}, {255, 0, 0}, {255, 0, 0}, {255, 18, 0}, {255, 101, 0}, {255, 154, 0}, {255, 166, 0}, {255, 143, 0}, {255, 84, 0}, }, {{255, 90, 0}, {255, 154, 0}, {255, 191, 0}, {255, 174, 0}, {255, 70, 0}, {255, 11, 0}, {255, 0, 0}, {255, 0, 0}, {255, 0, 0}, {255, 12, 0}, {255, 73, 0}, {255, 174, 0}, {255, 191, 0}, {255, 154, 0}, {255, 87, 0}, }, {{255, 88, 0}, {255, 193, 0}, {255, 224, 0}, {255, 169, 0}, {255, 93, 0}, {255, 33, 0}, {255, 15, 0}, {255, 0, 0}, {255, 16, 0}, {255, 34, 0}, {255, 93, 0}, {255, 170, 0}, {255, 224, 0}, {255, 192, 0}, {255, 87, 0}, }, {{255, 78, 0}, {255, 189, 0}, {255, 231, 0}, {255, 199, 0}, {255, 111, 0}, {255, 106, 0}, {255, 70, 0}, {255, 8, 0}, {255, 71, 0}, {255, 105, 0}, {255, 112, 0}, {255, 202, 0}, {255, 232, 0}, {255, 186, 0}, {255, 78, 0}, }, {{255, 50, 0}, {255, 126, 0}, {255, 236, 0}, {255, 214, 0}, {255, 165, 0}, {255, 201, 0}, {255, 129, 0}, {255, 94, 0}, {255, 131, 0}, {255, 201, 0}, {255, 165, 0}, {255, 215, 0}, {255, 235, 0}, {255, 122, 0}, {255, 50, 0}, }, {{255, 36, 0}, {255, 43, 0}, {255, 119, 0}, {255, 219, 0}, {255, 233, 0}, {255, 216, 0}, {255, 209, 0}, {255, 215, 0}, {255, 210, 0}, {255, 217, 0}, {255, 234, 0}, {255, 219, 0}, {255, 116, 0}, {255, 41, 0}, {255, 36, 0}, }, },
{{{255, 0, 0}, {255, 7, 0}, {255, 5, 0}, {255, 16, 0}, {255, 42, 0}, {255, 62, 0}, {255, 107, 0}, {255, 144, 0}, {255, 95, 0}, {255, 39, 0}, {255, 39, 0}, {255, 16, 0}, {255, 5, 0}, {255, 7, 0}, {255, 0, 0}, }, {{255, 8, 0}, {255, 47, 0}, {255, 10, 0}, {255, 7, 0}, {255, 13, 0}, {255, 20, 0}, {255, 34, 0}, {255, 58, 0}, {255, 20, 0}, {255, 17, 0}, {255, 12, 0}, {255, 6, 0}, {255, 11, 0}, {255, 47, 0}, {255, 8, 0}, }, {{255, 20, 0}, {255, 96, 0}, {255, 17, 0}, {255, 5, 0}, {255, 7, 0}, {255, 10, 0}, {255, 5, 0}, {255, 2, 0}, {255, 5, 0}, {255, 10, 0}, {255, 7, 0}, {255, 5, 0}, {255, 18, 0}, {255, 97, 0}, {255, 18, 0}, }, {{255, 29, 0}, {255, 134, 0}, {255, 25, 0}, {255, 7, 0}, {255, 7, 0}, {255, 9, 0}, {255, 7, 0}, {255, 6, 0}, {255, 7, 0}, {255, 9, 0}, {255, 7, 0}, {255, 7, 0}, {255, 27, 0}, {255, 133, 0}, {255, 27, 0}, }, {{255, 28, 0}, {255, 119, 0}, {255, 68, 0}, {255, 43, 0}, {255, 9, 0}, {255, 13, 0}, {255, 8, 0}, {255, 2, 0}, {255, 8, 0}, {255, 13, 0}, {255, 9, 0}, {255, 44, 0}, {255, 70, 0}, {255, 117, 0}, {255, 27, 0}, }, {{255, 35, 0}, {255, 110, 0}, {255, 138, 0}, {255, 68, 0}, {255, 10, 0}, {255, 8, 0}, {255, 6, 0}, {255, 0, 0}, {255, 6, 0}, {255, 8, 0}, {255, 10, 0}, {255, 70, 0}, {255, 138, 0}, {255, 110, 0}, {255, 35, 0}, }, {{255, 5, 0}, {255, 88, 0}, {255, 111, 0}, {255, 112, 0}, {255, 85, 0}, {255, 10, 0}, {255, 5, 0}, {255, 10, 0}, {255, 4, 0}, {255, 11, 0}, {255, 87, 0}, {255, 111, 0}, {255, 111, 0}, {255, 85, 0}, {255, 4, 0}, }, },
{{{255, 38, 0}, {255, 34, 0}, {255, 32, 0}, {255, 76, 0}, {255, 197, 0}, {255, 218, 0}, {255, 220, 0}, {255, 216, 0}, {255, 185, 0}, {255, 137, 0}, {255, 192, 0}, {255, 93, 0}, {255, 47, 0}, {255, 32, 0}, {255, 40, 0}, }, {{255, 1, 0}, {255, 4, 0}, {255, 2, 0}, {255, 22, 0}, {255, 89, 0}, {255, 174, 0}, {255, 188, 0}, {255, 175, 0}, {255, 127, 0}, {255, 144, 0}, {255, 117, 0}, {255, 50, 0}, {255, 1, 0}, {255, 3, 0}, {255, 1, 0}, }, {{255, 4, 0}, {255, 6, 0}, {255, 4, 0}, {255, 4, 0}, {255, 23, 0}, {255, 73, 0}, {255, 89, 0}, {255, 102, 0}, {255, 104, 0}, {255, 84, 0}, {255, 26, 0}, {255, 4, 0}, {255, 4, 0}, {255, 7, 0}, {255, 4, 0}, }, {{255, 3, 0}, {255, 15, 0}, {255, 8, 0}, {255, 5, 0}, {255, 6, 0}, {255, 15, 0}, {255, 32, 0}, {255, 54, 0}, {255, 20, 0}, {255, 16, 0}, {255, 7, 0}, {255, 5, 0}, {255, 8, 0}, {255, 15, 0}, {255, 3, 0}, }, {{255, 1, 0}, {255, 35, 0}, {255, 47, 0}, {255, 18, 0}, {255, 6, 0}, {255, 8, 0}, {255, 0, 0}, {255, 1, 0}, {255, 1, 0}, {255, 8, 0}, {255, 6, 0}, {255, 18, 0}, {255, 47, 0}, {255, 35, 0}, {255, 1, 0}, }, {{255, 4, 0}, {255, 79, 0}, {255, 42, 0}, {255, 22, 0}, {255, 3, 0}, {255, 6, 0}, {255, 4, 0}, {255, 0, 0}, {255, 4, 0}, {255, 7, 0}, {255, 3, 0}, {255, 22, 0}, {255, 42, 0}, {255, 78, 0}, {255, 3, 0}, }, {{255, 11, 0}, {255, 41, 0}, {255, 27, 0}, {255, 31, 0}, {255, 5, 0}, {255, 7, 0}, {255, 8, 0}, {255, 2, 0}, {255, 9, 0}, {255, 6, 0}, {255, 4, 0}, {255, 33, 0}, {255, 26, 0}, {255, 42, 0}, {255, 10, 0}, }, },
{{{255, 209, 0}, {255, 212, 0}, {255, 182, 0}, {255, 165, 0}, {255, 209, 0}, {255, 214, 0}, {255, 220, 0}, {255, 216, 0}, {255, 186, 0}, {255, 135, 0}, {255, 203, 0}, {255, 219, 0}, {255, 220, 0}, {255, 213, 0}, {255, 215, 0}, }, {{255, 197, 0}, {255, 209, 0}, {255, 198, 0}, {255, 119, 0}, {255, 169, 0}, {255, 203, 0}, {255, 189, 0}, {255, 175, 0}, {255, 127, 0}, {255, 172, 0}, {255, 213, 0}, {255, 210, 0}, {255, 209, 0}, {255, 214, 0}, {255, 206, 0}, }, {{255, 216, 0}, {255, 199, 0}, {255, 178, 0}, {255, 159, 0}, {255, 205, 0}, {255, 206, 0}, {255, 126, 0}, {255, 104, 0}, {255, 143, 0}, {255, 218, 0}, {255, 213, 0}, {255, 201, 0}, {255, 198, 0}, {255, 201, 0}, {255, 213, 0}, }, {{255, 127, 0}, {255, 44, 0}, {255, 54, 0}, {255, 116, 0}, {255, 200, 0}, {255, 208, 0}, {255, 191, 0}, {255, 148, 0}, {255, 135, 0}, {255, 200, 0}, {255, 193, 0}, {255, 114, 0}, {255, 59, 0}, {255, 48, 0}, {255, 135, 0}, }, {{255, 11, 0}, {255, 6, 0}, {255, 2, 0}, {255, 17, 0}, {255, 157, 0}, {255, 212, 0}, {255, 206, 0}, {255, 226, 0}, {255, 193, 0}, {255, 168, 0}, {255, 147, 0}, {255, 13, 0}, {255, 2, 0}, {255, 6, 0}, {255, 12, 0}, }, {{255, 10, 0}, {255, 7, 0}, {255, 1, 0}, {255, 3, 0}, {255, 43, 0}, {255, 149, 0}, {255, 206, 0}, {255, 162, 0}, {255, 120, 0}, {255, 122, 0}, {255, 47, 0}, {255, 3, 0}, {255, 1, 0}, {255, 7, 0}, {255, 10, 0}, }, {{255, 6, 0}, {255, 10, 0}, {255, 18, 0}, {255, 4, 0}, {255, 7, 0}, {255, 25, 0}, {255, 134, 0}, {255, 150, 0}, {255, 57, 0}, {255, 8, 0}, {255, 10, 0}, {255, 4, 0}, {255, 19, 0}, {255, 9, 0}, {255, 6, 0}, }, },
{{{0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, }, {{0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, }, {{0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, }, {{0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, }, {{0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, }, {{0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, }, {{0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, }, }};
const led_anim_direct_t explosion_anim_direct = {
    (rgbcolor_t (*)[7][15]) &explosion_frames,
    10,
    200,
};

// TODO: Use a different one:
const led_anim_t explosion_anim = {
                                      "explode",
                                      (led_anim_direct_t){
                                          .anim_frames=explosion_frames,
                                          .anim_len=10,
                                          .anim_frame_delay_ms=50
                                      },
                                      0,
                                      1
};

#define DIRECT_CNT 3

const led_anim_t *led_direct_anims[DIRECT_CNT] = {
                                       &send_anim,
                                       &recv_anim,
                                       &startup_anim,
                                       &explosion_anim
};

void led_next_frame_swi(UArg a0) {
    Event_post(ui_event_h, UI_EVENT_LED_FRAME);
}

void led_load_frame() {
    rgbcolor_t scratch[7][15];
    rgbcolor_t (*src)[15];

    if (led_anim_curr.direct_anim.anim_frames) {
        // If anim_frames is a valid pointer, this is a direct animation.
        src = led_anim_curr.direct_anim.anim_frames[led_anim_frame];
    } else {
        // If anim_frames is NULL, then we need to reference the SPI flash.
        storage_load_frame(led_anim_curr.name, led_anim_frame, scratch);
        src = scratch;
    }

    for (uint16_t r=0; r<7; r++) {
        for (uint16_t c=0; c<15; c++) {
            tlc_display_curr[r][c].red = src[r][c].red << 4;
            tlc_display_curr[r][c].green = src[r][c].green << 4;
            tlc_display_curr[r][c].blue = src[r][c].blue << 4;
        }
    }

    Clock_setTimeout(led_frame_clock_h, led_anim_curr.direct_anim.anim_frame_delay_ms*100);
    Clock_start(led_frame_clock_h);
}

void led_set_anim_direct(led_anim_t anim, uint8_t ambient) {
    if (ambient) {
        led_anim_ambient = anim;
    }
    led_curr_ambient = ambient;

    led_anim_curr = anim;
    led_anim_frame = 0;

    Event_post(tlc_event_h, TLC_EVENT_NEXTFRAME);
}

void led_set_anim(char *name, uint8_t ambient) {
    led_anim_t anim;
    if (storage_load_anim(name, &anim)) {
        led_set_anim_direct(anim, ambient);
    }
}

void led_next_frame() {
    led_anim_frame++;
    if (led_anim_frame >= led_anim_curr.direct_anim.anim_len) {
        if (led_curr_ambient) {
            led_anim_frame = 0;
        } else {
            led_set_anim_direct(led_anim_ambient, TRUE);
        }
    }

    Event_post(tlc_event_h, TLC_EVENT_NEXTFRAME);
}

/// Select our next available unlocked animation, and switch to it.
void led_next_anim() {
    char next_anim_name[ANIM_NAME_MAX_LEN] = {0x00,};
    // TODO: if led_anim_last_chosen isn't the current animation,
    //       just switch back to it.
    if (led_anim_last_chosen.id != led_anim_ambient.id) {
        led_set_anim(led_anim_last_chosen.name, 1);
        led_anim_id = led_anim_last_chosen.id;
    } else {
        storage_get_next_anim_name(next_anim_name);
        led_set_anim(next_anim_name, 1);
        led_anim_id = led_anim_ambient.id;
        // TODO: write this dramatically less often.
        storage_overwrite_file("/.animid", &led_anim_id, sizeof(led_anim_id));
        led_anim_last_chosen = led_anim_ambient;
    }
}

void led_init() {
    Clock_Params clockParams;
    Clock_Params_init(&clockParams);
    clockParams.period = 0; // one-shot
    clockParams.startFlag = FALSE;
    led_frame_clock_h = Clock_create(led_next_frame_swi, 1000, &clockParams, NULL);

    for (uint16_t i=0; i<DIRECT_CNT; i++) {
        if (!storage_anim_saved_and_valid(led_direct_anims[i]->name)) {
            storage_save_direct_anim(led_direct_anims[i]->name, &led_direct_anims[i]->direct_anim, 0);
        }
    }

    // TODO: Check whether storage loaded one correctly.
    led_set_anim(led_anim_curr.name, 1);
    led_anim_last_chosen = led_anim_curr;
    led_set_anim_direct(startup_anim, 0);
}
